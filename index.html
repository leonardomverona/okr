<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestão de OKRs/KPIs</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #4361ee;
      --secondary: #3f37c9;
      --success: #06d6a0;
      --warning: #ffd166;
      --danger: #ef476f;
      --highlight: #6C63FF;
      --background: #f8f9fa;
      --text: #2b2d42;
      --card-bg: #ffffff;
      --border: #e9ecef;
      --dark-bg: #1a1b1e;
      --dark-card: #2b2d42;
      --dark-text: #edf2f4;
      --border-radius: 0.75rem;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Inter', sans-serif;
      background: var(--background);
      color: var(--text);
      transition: all 0.3s ease;
    }
    body.dark-mode {
      --background: var(--dark-bg);
      --text: var(--dark-text);
      --card-bg: var(--dark-card);
      --border: #3a3d4d;
      --highlight: #4a44b2;
    }

    .dashboard {
      display: grid;
      grid-template-columns: 280px 1fr;
      min-height: 100vh;
    }

    .sidebar {
      background: var(--highlight);
      padding: 2rem 1rem;
      display: flex;
      flex-direction: column;
      gap: 2rem;
    }
    .sidebar .logo {
      font-size: 1.4rem;
      color: #fff;
      font-weight: 600;
      text-align: center;
      margin-bottom: 1rem;
    }
    .nav-links {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .nav-links a {
      color: #fff;
      text-decoration: none;
      padding: 0.75rem;
      border-radius: var(--border-radius);
      transition: background 0.3s;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .nav-links a:hover {
      background: rgba(255,255,255,0.1);
    }

    .export-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    .export-buttons button {
      background: var(--border);
      color: var(--primary);
      border: none;
      border-radius: var(--border-radius);
      padding: 0.5rem;
      font-size: 0.8rem;
      transition: background 0.3s;
      cursor: pointer;
    }
    .export-buttons button:hover {
      background: var(--secondary);
      color: #fff;
    }

    .main-content {
      padding: 2rem;
      display: flex;
      flex-direction: column;
      gap: 2rem;
    }

    /* Seções (Dashboard, Roadmap, Configurações) */
    #dashboardSection, #roadmapSection, #configSection {
      display: none;
    }
    #dashboardSection.active, 
    #roadmapSection.active, 
    #configSection.active {
      display: block;
    }

    .metrics-cards {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 1.5rem;
    }
    .metrics-card {
      background: var(--card-bg);
      padding: 1.5rem;
      border-radius: var(--border-radius);
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      text-align: center;
    }
    .card {
      background: var(--card-bg);
      padding: 1.5rem;
      border-radius: var(--border-radius);
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      border: 1px solid var(--border);
      transition: transform 0.3s ease;
    }
    .card:hover {
      transform: translateY(-3px);
    }

    .progress-bar {
      height: 14px;
      background: var(--border);
      border-radius: 8px;
      overflow: hidden;
      margin-top: 1rem;
    }
    .progress-fill {
      height: 100%;
      border-radius: 8px;
      transition: width 0.4s ease;
      background: linear-gradient(90deg, var(--secondary), var(--success));
    }

    .timeline {
      position: relative;
      padding: 1rem 0;
      height: 200px;
    }
    .timeline-item {
      position: absolute;
      height: 30px;
      background: var(--secondary);
      color: #fff;
      border-radius: var(--border-radius);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
    }
    .timeline-labels {
      position: relative;
      height: 20px;
      margin-top: 5px;
    }

    button {
      background: var(--primary);
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: 500;
    }
    button:hover {
      background: var(--secondary);
      transform: translateY(-2px);
    }

    /* Modal */
    .modal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      justify-content: center;
      align-items: center;
      backdrop-filter: blur(4px);
      z-index: 999;
    }
    .modal-content {
      background: var(--card-bg);
      padding: 2rem;
      border-radius: var(--border-radius);
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    .form-group {
      margin-bottom: 1.25rem;
    }
    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
    }
    input, select {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid var(--border);
      border-radius: var(--border-radius);
    }
  </style>
</head>
<body>
  <div class="dashboard">
    <!-- SIDEBAR -->
    <div class="sidebar">
      <div class="logo">
        <i class="fas fa-rocket"></i> Gestão OKR
      </div>
      <nav class="nav-links">
        <a href="#" onclick="changeSection('dashboardSection')">
          <i class="fas fa-tachometer-alt"></i>
          Dashboard
        </a>
        <a href="#" onclick="changeSection('roadmapSection')">
          <i class="fas fa-road"></i>
          Roadmap
        </a>
        <a href="#" onclick="changeSection('configSection')">
          <i class="fas fa-cog"></i>
          Configurações
        </a>
      </nav>
      <div class="export-buttons">
        <button onclick="exportJSON()">
          <i class="fas fa-file-export"></i> JSON
        </button>
        <button onclick="exportCSV()">
          <i class="fas fa-file-csv"></i> CSV
        </button>
        <button onclick="exportPDF()">
          <i class="fas fa-file-pdf"></i> PDF
        </button>
        <input type="file" id="importFile" accept=".json,.csv" style="display:none;">
        <button onclick="document.getElementById('importFile').click()">
          <i class="fas fa-file-import"></i> Importar
        </button>
      </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main-content">
      <!-- DASHBOARD -->
      <div id="dashboardSection" class="active">
        <h1>Bem-vindo ao painel estratégico OKR</h1>
        <div class="metrics-cards">
          <div class="metrics-card">
            <h4><i class="fas fa-bullseye"></i> OKRs Ativos</h4>
            <p id="okrsAtivosCount">0</p>
          </div>
          <div class="metrics-card">
            <h4><i class="fas fa-check-circle"></i> Concluídos</h4>
            <p id="okrsConcluidosCount">0</p>
          </div>
          <div class="metrics-card">
            <h4><i class="fas fa-chart-line"></i> KPIs Ativos</h4>
            <p id="kpisAtivosCount">0</p>
          </div>
          <div class="metrics-card">
            <h4><i class="fas fa-tasks"></i> Progresso Médio</h4>
            <p id="progressoMedio">0%</p>
          </div>
        </div>

        <div class="card">
          <h3><i class="fas fa-chart-bar"></i> Progresso Global</h3>
          <div class="progress-bar">
            <div class="progress-fill" id="globalProgress" style="width: 0%;"></div>
          </div>
        </div>

        <div class="card">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3><i class="fas fa-bullseye"></i> Objetivos Ativos</h3>
            <button onclick="openModal('okr')">
              <i class="fas fa-plus"></i> Novo OKR
            </button>
          </div>
          <div id="okrList"></div>
        </div>
      </div>

      <!-- ROADMAP -->
      <div id="roadmapSection">
        <div class="card">
          <h3><i class="fas fa-road"></i> Roadmap Estratégico</h3>
          <div class="timeline" id="roadmapContent"></div>
          <div class="timeline-labels" id="timelineLabels"></div>
        </div>
      </div>

      <!-- CONFIGURAÇÕES -->
      <div id="configSection">
        <div class="card">
          <h3><i class="fas fa-cog"></i> Configurações</h3>
          <p>Ajuste preferências do sistema aqui...</p>
          <button onclick="toggleTheme()">
            <i class="fas fa-moon"></i> Alternar Tema
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL GERAL -->
  <div class="modal" id="modal">
    <div class="modal-content">
      <h3 id="modalTitle"></h3>
      <form id="form" onsubmit="handleFormSubmit(event)">
        <div id="formContent"></div>
        <div style="margin-top: 1.5rem; display: flex; gap: 1rem; justify-content: flex-end;">
          <button type="button" onclick="closeModal()">
            <i class="fas fa-times"></i> Cancelar
          </button>
          <button type="submit">
            <i class="fas fa-save"></i> Salvar
          </button>
        </div>
      </form>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    function changeSection(sectionId) {
      ['dashboardSection','roadmapSection','configSection'].forEach(sec => {
        document.getElementById(sec).classList.remove('active');
      });
      document.getElementById(sectionId).classList.add('active');
      if (sectionId === 'roadmapSection') {
        okrSystem.renderRoadmap();
      }
    }

    function toggleTheme() {
      document.body.classList.toggle('dark-mode');
      localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
    }

    class OKRSystem {
      constructor() {
        this.okrs = [];
        this.kpis = [];
        this.loadData();
        this.autoSave();
        this.render();
      }

      loadData() {
        const data = localStorage.getItem('okrData');
        if (data) {
          try {
            const parsed = JSON.parse(data);
            this.okrs = parsed.okrs || [];
            this.kpis = parsed.kpis || [];
          } catch (error) {
            console.error('Erro ao carregar dados:', error);
          }
        }
      }

      saveData() {
        localStorage.setItem('okrData', JSON.stringify({
          okrs: this.okrs,
          kpis: this.kpis
        }));
      }

      autoSave() {
        window.addEventListener('beforeunload', () => this.saveData());
      }

      addOKR(title, target, startDate, endDate) {
        this.okrs.push({
          id: Date.now().toString(),
          title,
          target,
          startDate,
          endDate,
          progress: 0
        });
        this.saveData();
        this.render();
      }

      addKPI(name, okrId, startDate, endDate, current, target, weight) {
        if (new Date(startDate) > new Date(endDate)) {
          alert('A data inicial do KPI deve ser anterior à data final.');
          return;
        }
        const newKPI = {
          id: Date.now().toString(),
          name,
          okrId,
          startDate,
          endDate,
          current: parseFloat(current),
          target: parseFloat(target),
          weight: parseFloat(weight) || 1
        };
        this.kpis.push(newKPI);
        this.calculateProgress();
        this.saveData();
      }

      deleteOKR(id) {
        this.okrs = this.okrs.filter(o => o.id !== id);
        this.kpis = this.kpis.filter(k => k.okrId !== id);
        this.saveData();
        this.render();
      }

      deleteKPI(id) {
        this.kpis = this.kpis.filter(k => k.id !== id);
        this.calculateProgress();
        this.saveData();
      }

      calculateProgress() {
        this.okrs.forEach(okr => {
          const relatedKPIs = this.kpis.filter(k => k.okrId === okr.id);
          if (relatedKPIs.length > 0) {
            const totalWeighted = relatedKPIs.reduce((sum, k) => sum + ((k.current / k.target) * 100 * k.weight), 0);
            const totalWeight = relatedKPIs.reduce((sum, k) => sum + k.weight, 0);
            okr.progress = totalWeight > 0 ? (totalWeighted / totalWeight).toFixed(1) : 0;
          } else {
            okr.progress = 0;
          }
        });
        this.render();
      }

      getIndicatorColor(progress) {
        progress = parseFloat(progress);
        if (progress >= 90) return 'var(--success)';
        if (progress >= 60) return 'var(--warning)';
        return 'var(--danger)';
      }

      updateMetrics() {
        const activeOKRs = this.okrs.filter(o => parseFloat(o.progress) < 100).length;
        const completedOKRs = this.okrs.filter(o => parseFloat(o.progress) >= 100).length;
        const totalKPIs = this.kpis.length;
        const avgProgress = this.okrs.length > 0 
          ? this.okrs.reduce((sum, o) => sum + parseFloat(o.progress), 0) / this.okrs.length
          : 0;
        
        document.getElementById('okrsAtivosCount').textContent = activeOKRs;
        document.getElementById('okrsConcluidosCount').textContent = completedOKRs;
        document.getElementById('kpisAtivosCount').textContent = totalKPIs;
        document.getElementById('progressoMedio').textContent = `${avgProgress.toFixed(1)}%`;
        document.getElementById('globalProgress').style.width = `${avgProgress}%`;
      }

      renderOKRs() {
        const container = document.getElementById('okrList');
        if (!container) return;
        if (this.okrs.length === 0) {
          container.innerHTML = '<p>Nenhum OKR cadastrado.</p>';
          return;
        }
        container.innerHTML = this.okrs.map(okr => `
          <div class="kpi-card" style="border-color: ${this.getIndicatorColor(okr)};">
            <h4>${okr.title}</h4>
            <p><strong>Meta:</strong> ${okr.target}</p>
            <p><strong>Data Inicial:</strong> ${okr.startDate}</p>
            <p><strong>Data Final:</strong> ${okr.endDate}</p>
            <p><strong>Grade * Wgt:</strong> ${okr.gradeWeighted}</p>
            <p><strong>Status:</strong> ${computeStatus(okr)}</p>
            <p><strong>Wgt:</strong> ${okr.weight}</p>
            <div class="progress-bar">
              <div class="progress-fill" style="width: ${okr.progress}%; background: ${this.getIndicatorColor(okr)};"></div>
              <span class="progress-text">${okr.progress}%</span>
            </div>
            <div style="margin-top: 0.5rem; display: flex; gap: 0.5rem;">
              <button onclick="openEditModal('okr', '${okr.id}')">Editar</button>
              <button onclick="okrSystem.deleteOKR('${okr.id}')">Excluir</button>
              <button onclick="openEditModal('kpi', null, '${okr.id}')">+ Adicionar KPI</button>
            </div>
            ${this.renderAssociatedKPIs(okr.id)}
          </div>
        `).join('');
      }

      renderAssociatedKPIs(okrId) {
        const associated = this.kpis.filter(k => k.okrId === okrId);
        if (associated.length === 0) return '';
        return `<div style="margin: 0.5rem 0 0 1rem; border-left: 2px dashed var(--border); padding-left: 1rem;">
          ${associated.map(kpi => {
            const progress = kpi.target > 0 ? (kpi.current / kpi.target) * 100 : 0;
            const color = this.getIndicatorColor(progress);
            return `
              <div style="font-size: 0.9rem; margin-bottom: 1rem; border-left: 4px solid ${color}; padding: 0.5rem;">
                <strong>${kpi.name}</strong>
                <p><small>De: ${kpi.startDate} até ${kpi.endDate}</small></p>
                <p>Atual: ${kpi.current} / Alvo: ${kpi.target} (Peso: ${kpi.weight})</p>
                <div class="progress-bar" style="height: 8px;">
                  <div class="progress-fill" style="width: ${progress}%; background: ${color};"></div>
              </div>
              <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                <button onclick="openEditModal('kpi', '${kpi.id}')">Editar</button>
                <button onclick="okrSystem.deleteKPI('${kpi.id}')">Excluir</button>
              </div>
            `;
          }).join('')}
        </div>`;
      }

      renderRoadmap() {
        const container = document.getElementById('roadmapContent');
        const sortedOKRs = [...this.okrs].sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
        if (sortedOKRs.length === 0) {
          container.innerHTML = '<p>Nenhum OKR cadastrado.</p>';
          return;
        }
        // Determina intervalo total
        let minDate = new Date(Math.min(...sortedOKRs.map(o => new Date(o.startDate).getTime())));
        let maxDate = new Date(Math.max(...sortedOKRs.map(o => new Date(o.endDate).getTime())));
        minDate.setMonth(minDate.getMonth() - 1);
        maxDate.setMonth(maxDate.getMonth() + 1);
        const timelineStart = minDate.getTime();
        const timelineEnd = maxDate.getTime();
        const totalDuration = timelineEnd - timelineStart;

        let timelineHTML = `<div style="position: relative; height: 150px;">`;
        sortedOKRs.forEach((okr, index) => {
          const startMs = new Date(okr.startDate).getTime();
          const endMs = new Date(okr.endDate).getTime();
          const leftPercent = ((startMs - timelineStart) / totalDuration) * 100;
          const widthPercent = ((endMs - startMs) / totalDuration) * 100;
          const color = this.getIndicatorColor(okr.progress);
          timelineHTML += `
            <div class="timeline-item" style="position: absolute; top: ${index * 35}px; left: ${leftPercent}%; width: ${widthPercent}%; background: ${color}; color: #fff;">
              ${okr.title}
            </div>
          `;
        });
        timelineHTML += `</div>`;
        container.innerHTML = timelineHTML;
      }

      render() {
        this.renderOKRs();
        this.renderRoadmap();
        this.updateMetrics();
      }
    }

    const okrSystem = new OKRSystem();

    // Alternar seções
    function changeSection(sectionId) {
      const sections = ['dashboardSection','roadmapSection','configSection'];
      sections.forEach(sec => {
        document.getElementById(sec).style.display = (sec === sectionId) ? 'block' : 'none';
      });
      if (sectionId === 'roadmapSection') {
        okrSystem.renderRoadmap();
      }
    }

    // Modal
    function openEditModal(type, itemId = null, parentId = null) {
      let item = null;
      if (type === 'okr' && itemId) {
        item = okrSystem.okrs.find(o => o.id === itemId);
      } else if (type === 'kpi' && itemId) {
        item = okrSystem.kpis.find(k => k.id === itemId);
      }
      showModal(type, item, parentId);
    }

    function showModal(type, item = null, parentId = null) {
      const modal = document.getElementById('modal');
      modal.style.display = 'flex';
      const isEdit = item !== null;
      const form = document.getElementById('form');
      if (isEdit) {
        form.dataset.editId = item.id;
      } else {
        delete form.dataset.editId;
      }
      let formContent = "";
      if (type === 'okr') {
        formContent = `
          <div class="form-group">
            <label>Título do OKR</label>
            <input type="text" id="title" value="${isEdit ? item.title : ''}" required>
          </div>
          <div class="form-group">
            <label>Meta</label>
            <input type="text" id="target" value="${isEdit ? item.target : ''}" required>
          </div>
          <div class="form-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div>
              <label>Data Inicial</label>
              <input type="date" id="startDate" value="${isEdit ? item.startDate : ''}" required>
            </div>
            <div>
              <label>Data Final</label>
              <input type="date" id="endDate" value="${isEdit ? item.endDate : ''}" required>
            </div>
          </div>
          <div class="form-group">
            <label>Grade</label>
            <input type="number" id="grade" min="0" max="100" value="${isEdit ? item.grade : ''}" required>
          </div>
          <div class="form-group">
            <label>Wgt (Peso)</label>
            <input type="number" id="weight" min="0" step="0.1" value="${isEdit ? item.weight : '1'}" required>
          </div>
          <div class="form-group">
            <label>Grade * Wgt</label>
            <input type="text" id="gradeWeighted" readonly>
          </div>
          <div class="form-group">
            <label>Status</label>
            <input type="text" id="statusDisplay" readonly value="${isEdit ? computeStatus(item) : ''}">
          </div>
        `;
      } else { // KPI
        formContent = `
          <div class="form-group">
            <label>Nome do KPI</label>
            <input type="text" id="name" value="${isEdit ? item.name : ''}" required>
          </div>
          <div class="form-group">
            <label>Vincular a OKR</label>
            <select id="okrId" required>
              <option value="">Selecione um OKR</option>
              ${okrSystem.okrs.map(o => `<option value="${o.id}" ${isEdit && item.okrId === o.id ? 'selected' : ''}>${o.title}</option>`).join('')}
            </select>
          </div>
          <div class="form-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div>
              <label>Data Inicial</label>
              <input type="date" id="startDateKPI" value="${isEdit ? item.startDate : ''}" required>
            </div>
            <div>
              <label>Data Final</label>
              <input type="date" id="endDateKPI" value="${isEdit ? item.endDate : ''}" required>
            </div>
          </div>
          <div class="form-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div>
              <label>Valor Atual</label>
              <input type="number" id="current" step="0.1" value="${isEdit ? item.current : ''}" required>
            </div>
            <div>
              <label>Valor Alvo</label>
              <input type="number" id="targetKPI" step="0.1" value="${isEdit ? item.target : ''}" required>
            </div>
          </div>
          <div class="form-group">
            <label>Peso (0 a 1): <span id="weightKPIValue">${isEdit ? item.weight : '1'}</span></label>
            <input type="range" id="weightKPI" min="0" max="1" step="0.1" value="${isEdit ? item.weight : '1'}"
                   oninput="document.getElementById('weightKPIValue').innerText = this.value">
          </div>
        `;
      }
      document.getElementById('formContent').innerHTML = formContent;
      document.getElementById('modalTitle').textContent = isEdit 
          ? `Editar ${type === 'okr' ? 'OKR' : 'KPI'}` 
          : `Novo ${type === 'okr' ? 'OKR' : 'KPI'}`;
      if (!isEdit && type === 'kpi' && parentId) {
        document.getElementById('okrId').value = parentId;
      }
      if (type === 'okr') {
        computeWeightedValues();
        const gradeField = document.getElementById('grade');
        const weightField = document.getElementById('weight');
        if (gradeField && weightField) {
          gradeField.addEventListener('input', computeWeightedValues);
          weightField.addEventListener('input', computeWeightedValues);
        }
      }
    }

    function closeModal() {
      document.getElementById('modal').style.display = 'none';
      document.getElementById('form').reset();
    }

    function handleFormSubmit(e) {
      e.preventDefault();
      const title = document.getElementById('modalTitle').textContent;
      if (title === 'Novo OKR') {
        const okrTitle = document.getElementById('okrTitle').value;
        const okrTarget = document.getElementById('okrTarget').value;
        const okrStart = document.getElementById('okrStartDate').value;
        const okrEnd = document.getElementById('okrEndDate').value;
        if (new Date(okrStart) > new Date(okrEnd)) {
          alert('A data inicial deve ser anterior à data final.');
          return;
        }
        okrSystem.addOKR(okrTitle, okrTarget, okrStart, okrEnd);
      } else {
        const kpiName = document.getElementById('kpiName').value;
        const kpiOKR = document.getElementById('kpiOKR').value;
        const kpiStart = document.getElementById('kpiStartDate').value;
        const kpiEnd = document.getElementById('kpiEndDate').value;
        const kpiCurrent = document.getElementById('kpiCurrent').value;
        const kpiTarget = document.getElementById('kpiTarget').value;
        const kpiWeight = document.getElementById('kpiWeight').value;
        if (new Date(kpiStart) > new Date(kpiEnd)) {
          alert('A data inicial do KPI deve ser anterior à data final.');
          return;
        }
        if (parseFloat(kpiCurrent) > parseFloat(kpiTarget)) {
          alert('O valor atual não pode ser maior que o valor alvo.');
          return;
        }
        okrSystem.addKPI(kpiName, kpiOKR, kpiStart, kpiEnd, kpiCurrent, kpiTarget, kpiWeight);
      }
      closeModal();
    }

    // Exportar dados em JSON
    function exportJSON() {
      const data = {
        okrs: okrSystem.okrs,
        kpis: okrSystem.kpis
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `okr_data_${new Date().toISOString().split('T')[0]}.json`;
      a.click();
    }

    // Exportar dados em CSV
    function exportCSV() {
      let csv = "";
      csv += '"Tipo","Título","Meta","Data Inicial","Data Final","Grade","Wgt","Grade*Wgt","Progresso","Status"\n';
      okrSystem.okrs.forEach(okr => {
        csv += `"OKR","${okr.title}","${okr.target}","${okr.startDate}","${okr.endDate}","${okr.grade}","${okr.weight}","${okr.gradeWeighted}","${okr.progress}","${okr.statusLabel}"\n`;
      });
      csv += "\n";
      csv += '"Tipo","Nome do KPI","OKR ID","Valor Atual","Valor Alvo","Peso"\n';
      okrSystem.kpis.forEach(kpi => {
        csv += `"KPI","${kpi.name}","${kpi.okrId}","${kpi.current}","${kpi.target}","${kpi.weight}"\n`;
      });
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `okr_data_${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
    }

    // Exportar dados em PDF
    function exportPDF() {
      const doc = new jspdf.jsPDF();
      let y = 20;
      doc.setFontSize(14);
      doc.text('Relatório de OKRs', 20, y);
      y += 10;
      okrSystem.okrs.forEach(okr => {
        doc.setFontSize(12);
        doc.text(`OKR: ${okr.title}`, 20, y);
        y += 8;
        doc.text(`Meta: ${okr.target}`, 20, y);
        y += 8;
        doc.text(`Data: ${okr.startDate} - ${okr.endDate}`, 20, y);
        y += 8;
        doc.text(`Grade*Wgt: ${okr.gradeWeighted} | Progresso: ${okr.progress}% | Status: ${okr.statusLabel}`, 20, y);
        y += 8;
        const associated = okrSystem.kpis.filter(kpi => kpi.okrId === okr.id);
        associated.forEach(kpi => {
          doc.text(`   KPI: ${kpi.name} - ${kpi.current}/${kpi.target} (Peso: ${kpi.weight})`, 20, y);
          y += 6;
        });
        y += 10;
        if (y > 270) {
          doc.addPage();
          y = 20;
        }
      });
      doc.save(`okr_data_${new Date().toISOString().split('T')[0]}.pdf`);
    }

    // Evento para importação de dados (JSON ou CSV)
    document.getElementById('importFile').addEventListener('change', function(e) {
      const file = e.target.files[0];
      const reader = new FileReader();
      reader.onload = function() {
        if (file.name.endsWith('.csv')) {
          importCSV(reader.result);
        } else {
          try {
            const data = JSON.parse(reader.result);
            okrSystem.okrs = data.okrs || [];
            okrSystem.kpis = data.kpis || [];
            okrSystem.render();
          } catch (error) {
            alert('Erro ao importar os dados.');
          }
        }
      };
      reader.readAsText(file);
    });

    // Função para importar CSV
    function importCSV(csvText) {
      const sections = csvText.split(/\n\s*\n/);
      const okrData = [];
      const kpiData = [];
      if (sections.length > 0) {
        const lines = sections[0].trim().split("\n");
        lines.shift(); // remover cabeçalho OKR
        lines.forEach(line => {
          if (line.trim() !== "") {
            const values = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(v => v.replace(/^"(.*)"$/, '$1'));
            okrData.push({
              id: Date.now().toString() + Math.random().toString().slice(2),
              title: values[1],
              target: values[2],
              startDate: values[3],
              endDate: values[4],
              grade: parseFloat(values[5]),
              weight: parseFloat(values[6]),
              gradeWeighted: values[7],
              progress: values[8],
              statusLabel: values[9]
            });
          }
        });
      }
      if (sections.length > 1) {
        const lines = sections[1].trim().split("\n");
        lines.shift(); // remover cabeçalho KPI
        lines.forEach(line => {
          if (line.trim() !== "") {
            const values = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(v => v.replace(/^"(.*)"$/, '$1'));
            kpiData.push({
              id: Date.now().toString() + Math.random().toString().slice(2),
              name: values[1],
              okrId: values[2],
              current: parseFloat(values[3]),
              target: parseFloat(values[4]),
              weight: parseFloat(values[5])
            });
          }
        });
      }
      okrSystem.okrs = okrData;
      okrSystem.kpis = kpiData;
      okrSystem.render();
    }

    // Inicializa o sistema assim que o DOM estiver carregado
    window.addEventListener('DOMContentLoaded', () => {
      okrSystem.render();
    });

    // Checar se o tema salvo é o dark
    if (localStorage.getItem('theme') === 'dark') {
      document.body.classList.add('dark-mode');
    }
  </script>
</body>
</html>